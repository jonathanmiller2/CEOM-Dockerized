version: '3'
    
services:

  web:
    build: ./app

    #****WARNING***** TODO: REMOVE THE FLUSH COMMAND BELOW WITH LIVE DATA, IT WILL LITERALLY DELETE EVERYTHING IN THE DATABASE ****WARNING*****
    #If Django is reporting an issue with relations not existing, this may help, but DO NOT RUN THIS COMMAND IF DJANGO IS IN ANY WAY TIED TO THE ONLY COPY OF THE DATA YOU HAVE. IT WILL INSTANTLY DELETE IT WITH NO BACKUP.
    command: bash -c "python manage.py reset_db --noinput &&
                      echo RESET_DB_FIN &&         
                      python manage.py flush --noinput &&         
                      echo FLUSH_FIN &&
                      python manage.py makemigrations &&
                      echo MAKEMIGRATIONS_FIN &&
                      python manage.py migrate --noinput -v 1 && 
                      echo MIGRATE_FIN &&
                      python manage.py loaddata flatpage.json &&
                      echo LOADDATA_FIN &&
                      python manage.py check &&
                      echo CHECK_FIN &&
                      gunicorn eomf.wsgi:application --bind 0.0.0.0:8000"
                      #python manage.py runserver 0.0.0.0:8000"

    #TODO: Remove the volume connection in production. There should be no connection between the container and machine in production to avoid attacks on the base machine.
    volumes:
      - ./app:/code
    expose:
      - 8000            
    env_file:
      - ./.env
    depends_on:
      - db
      - redis



  db:
    image: postgis/postgis
    volumes:
      - postgres_data:/var/lib/postgresql/data

    env_file:
      - ./.env.db



  nginx:
    build: ./nginx
    ports:
      - 80:80
    depends_on:
      - web
  


#  redis:
#    image: redis:alpine
#
#
#
#  celery:
#    build: ./app
#    command: celery -A eomf worker -l info
#    volumes:
#      - ./app/:/code/
#    
#    #Env variables may be needed here?
#
#    depends_on:
#      - redis

      
volumes:
  postgres_data: