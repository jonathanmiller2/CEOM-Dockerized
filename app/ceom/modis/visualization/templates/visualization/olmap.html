    {% extends "visualization/base.html" %}

{% block title %} Data Visualization {% endblock %}

{% block head_extra %}
 <!-- <script src="/media/js/modis.js" type="text/javascript"></script> -->
 <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBo98LuzUr-aVpxRZPFHkBl2m4ogHeROGQ" type="text/javascript"></script>

<style type="text/css">
.map  {position: relative; width: 658px; height: 370px; top: 25px; left: 0px; border: solid #999999 1px;}
.legend {position: absolute; top: 0px; left: 670px; text-align: left; z-index: 999999;}
.info  {position: relative; width: 658px; height: 50px; bottom: 3px; padding: 5px; background-color: #EEE; border: solid 1px #999999; text-align: left;}
#control {  position: absolute; top: 480px; left: 10px; z-index: 999999; }
.btn-outline-secondary:hover{color: white !important}
.btn-outline-secondary {color: black; max-height: 40px}
.pos { max-width: 80px; float:right; background-color: #ffffff00; border-color: #ffffff00; font-size: 0.8em}
.pos-bar{position: relative; width: 658px; height: 10px; bottom: 25px; padding: 5px; right: 35px;}
</style>
{% endblock %}

{% block content %}
<h3>Multi-pane MODIS Browser</h3>
<nav>
    <h4>Controls</h4>
    <div class="row ml-1 my-3">
        <button id="add_map" type="button"  class="btn btn-sm btn-primary mr-1">
            <span>Add Map</span>
        </button>
        <button id="modis-data" type="button" onClick='viewCurrentTS();return false' class="btn btn-sm btn-primary">
            <span>View MODIS Time Series Data</span>
        </button>
    </div>
    <div class="row ml-1">
        Click within any map window in order to synchronize map windows views to the same center position.
        <br>
        To change map view independently drag the map or use select tool.
        <br>
        To zoom all maps to the same altitude click the 'Synch Zoom' button.
    </div>
</nav>
<div id="map-1">
    <div class="row ml-1">
       
        <div id="map1" class="map" style="height: 400px"> 
            <div id="legend1" class="legend"></div>
        </div>

        <div style="float:right">
            <label class="mt-4 mx-3">EVI</label>
        </div>
        <div class="pos-bar">
            <input class="pos" id="LAT">
            <input class="pos" id="LON">
        </div>
        <div id="info" class="info">
            <div class="form-row">
                <div class="form-group col-2">
                    <select class="form-control" name="products">
                        {% for product in products %}
                        <option selected>{{ product }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group col-2">
                    <select class="form-control" name="days">
                        {% for day in days %}
                        <option selected>{{ day }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group col-2">
                    <select class="form-control" name="years">
                        {% for year in years %}
                        <option selected>{{ year }}</option>
                        {% endfor %}
                    </select>
                </div>
                <input type="hidden" class="form-control" name="map_num" value="1" />
                <input type="button" class="btn btn-light btn-outline-secondary button mr-2" value="Update Modis Map" onclick="javascript:updateMap();return false;"/>
                <input type="button" class="btn btn-light btn-outline-secondary button" id= "synch-zoom" value="Synch Zoom" onclick="synch_zoom(1)";/>
            </div>
        </div>
    </div>
</div>
<div id="map-2">
    <div class="row ml-1">
            <div id="map2" class="map" style="height:400px">
                <div id="legend2" class="legend"></div>
            </div>

        <div style="float:right">
            <label class="mt-4 mx-3">EVI</label>
        </div>
        <div class="pos-bar">
            <input class="pos" id="LAT2">
            <input class="pos" id="LON2">
        </div>
        <div id="info" class="info">
            <div class="form-row">
                <div class="form-group col-2">
                    <select class="form-control" name="products">
                        {% for product in products %}
                        <option selected>{{ product }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group col-2">
                    <select class="form-control" name="days">
                        {% for day in days %}
                        <option selected>{{ day }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group col-2">
                    <select class="form-control" name="years">
                        {% for year in years %}
                        <option selected>{{ year }}</option>
                        {% endfor %}
                    </select>
                </div>
                <input type="hidden" class="form-control" name="map_num" value="1" />
                <input type="button" class="btn btn-light btn-outline-secondary button mr-2" value="Update Modis Map" onclick="javascript:updateMap();return false;"/>
                <input type="button" class="btn btn-light btn-outline-secondary button" id="synch-zoom" value="Synch Zoom" onclick="synch_zoom(2)"/>
                <!-- onclick="javascript:synchZoom(this.form);return false;" -->
                <!-- onclick=javascript:"synch_zoom(" + mapArray[1][0] + ")";return false -->
            </div>
        </div>
    </div>
</div>
<div id="map-container"></div>
<script>
    var startLocation = {
        lat: 0,
        lng: 0
    };
    var myOptions = {
        zoom: 2,
        center: startLocation,
        gestureHandling: 'cooperative',
        mapTypeId: 'terrain',
    }
    map1 = new google.maps.Map(document.getElementById('map1'), myOptions);
   
    map2 = new google.maps.Map(document.getElementById('map2'), myOptions)

    map1.addListener("mouseover", (evt) => {
        let lat = evt.latLng.lat().toFixed(5);
        let lon = evt.latLng.lng().toFixed(5);

        $('#LAT').val(lat)
        $('#LON').val(lon)
    });

    map1.addListener("mousemove", (evt) => {
        let lat = evt.latLng.lat().toFixed(5);
        let lon = evt.latLng.lng().toFixed(5);

        $('#LAT').val(lat)
        $('#LON').val(lon)
    });
    map2.addListener("mouseover", (evt) => {
        let lat = evt.latLng.lat().toFixed(5);
        let lon = evt.latLng.lng().toFixed(5);
        
        $('#LAT2').val(lat)
        $('#LON2').val(lon)
    });
    map2.addListener("mousemove", (evt) => {
        let lat = evt.latLng.lat().toFixed(5);
        let lon = evt.latLng.lng().toFixed(5);
        
        $('#LAT2').val(lat)
        $('#LON2').val(lon)
    });

    let mapArray = [
        [1, map1], 
        [2, map2]
    ];
    let mapCounter = 3;
    let idCounter = 3;

    function synch_zoom(id) {
        //get the zoom/center from the map with the id that was passed to the function
        let center = mapArray[id - 1][1].getCenter();
        let zoom = mapArray[id - 1][1].getZoom();
        //for each (id,map) pair in the big map array:
            //if the id isn't the same as the id that was passed to the function:
            //sync the zoom/center of the map to the one we stored above
        for(let i = 0; i < mapArray.length; i++) {
            if(mapArray[i][0] != id) {
                mapArray[i][1].setCenter(center);
                mapArray[i][1].setZoom(zoom);
            }
        }
    }
   
    
    $('#add_map').click(function() {
        // Does every map need a different id?
        map = new google.maps.Map($("#map"+mapCounter), myOptions);
        mapArray.push([mapCounter, map]);
        let div = '<div id=\'"map-" + mapCounter\'><div id="map-container"><div class="row ml-1"><div id="map" class="map" style="height:400px"><div id="legend2" class="legend"></div></div><div style="float:right"><label class="mt-4 mx-3">EVI</label></div><div class="pos-bar"><input class="pos" id="LAT2"><input class="pos" id="LON2"></div><div id="info" class="info"><div class="form-row"><div class="form-group col-2"><select class="form-control" name="products">{% for product in products %}<option selected>{{ product }}</option>{% endfor %}</select></div><div class="form-group col-2"><select class="form-control" name="days">{% for day in days %}<option selected>{{ day }}</option>{% endfor %}</select></div><div class="form-group col-2"><select class="form-control" name="years">{% for year in years %}<option selected>{{ year }}</option>{% endfor %}</select></div><input type="hidden" class="form-control" name="map_num" value="1" /><input type="button" class="btn btn-light btn-outline-secondary button mr-2" value="Update Modis Map" onclick="javascript:updateMap();return false;"/><input type="button" class="btn btn-light btn-outline-secondary button" id="synch-zoom" value="Synch Zoom" onclick=\'javascript:"synch_zoom(" + mapArray[mapCounter - 1][0] + ")";return false\'/></div></div></div></div></div>'
        let chunk = $('#map-container').append(div);
        chunk.attr('id', 'map-' + idCounter);

        console.log(mapCounter);
        console.log(mapArray[mapCounter - 1][0])
        //chunk.find("#sync-zoom-button").click(synch_zoom_function)
        ++idCounter;
        ++mapCounter;
    })



    // Make sure to add the addListeners somewhere around here
</script>
{% endblock %}
