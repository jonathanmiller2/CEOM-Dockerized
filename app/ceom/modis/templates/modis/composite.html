{% extends "modis/base.html" %}

{% load i18n %}
{% block title %} {% trans "CEOM MODIS Composite Image Visualization" %} {% endblock %}

{% block head_extra %}
<script src="/static/ol/ol.js"></script>
{% endblock %}

{% block body_tag %}
<body bgcolor="#FFFFFF">
{% endblock %}
	{% block content %}
	<script type="text/javascript">
		function image_error() {
			var src = "/media/composite/not_available.png";
			$("#map").attr("src", src);
		}
		$(function () {
			$("#accordion").accordion({
				heightStyle: "content",
				collapsible: true,
				active: false
			});
		});
		$(function () {
			$("#CAL_DATE").datepicker({
				changeMonth: true,
				changeYear: true
			});
		});

		function calendarSubmit() {
			var value = document.getElementById("CAL_DATE").value
			console.log(value)
			if (value != "") {
				var day = parseInt($.datepicker.formatDate("o", new Date(value)))
				var year = parseInt($.datepicker.formatDate("yy", new Date(value)))

			} else {
				alert("Please select a date by clicking on the calendar input and picking the desired date.")
			}
			console.log(year.toString())
			console.log(day.toString())
			window.location.replace("/composite/" + year.toString() + "/" + day.toString() + "/");
		}

		function julianSubmit() {
			var year = parseInt(document.getElementById("JUL_YEAR").value);
			var day = parseInt(document.getElementById("JUL_DAY").value);
			var text = /^[0-9]+$/;
			if ((year != "") && (!text.test(year))) {
				alert("Please Enter Numeric Values Only for the year");
				return false;
			}
			if (year.toString().length != 4) {
				alert("Year is not proper. Please check format (YYYY)");
				return false;
			}
			var current_year = new Date().getFullYear();
			if ((year < 2000)) {
				alert("Year should be in range 2000");
				return false;
			}
			if ((day != "") && (!text.test(day))) {
				alert("Please Enter Numeric Values Only for the day");
			} else {
				if ((day != "") && (text.test(day)) && (day > 366 || day < 1)) {
					alert("Please Enter a day from 1 to 366");
				}
			}

			window.location.replace("/composite/" + year.toString() + "/" + day.toString() + "/");


		}

		

		function set50km() {
			map.removeLayer(graphic, false);
			graphic = new ol.layer.Image({
				source: new ol.source.ImageStatic({
					url: 'https://landweb.nascom.nasa.gov/browse/images/{{version}}/{{sat_name}}/{{prod}}/{{year}}/A{{year}}{{julian_day}}/MOD09.A{{year}}{{julian_day}}.{{version}}.png',
					projection: new ol.proj.Projection({
						code: 'comp-img',
						units: 'pixels',
						extent: [-180, -90, 180, 90],
					}),
					imageExtent: [-180, -90, 180, 90],
				}),
			});
			map.addLayer(graphic);
		}

		function set5km() {
			map.removeLayer(graphic, false);
			graphic = new ol.layer.Image({
				source: new ol.source.ImageStatic({
					url: 'https://landweb.nascom.nasa.gov/browse/images/{{version}}/{{sat_name}}/{{prod}}/{{year}}/A{{year}}{{julian_day}}/MOD09.A{{year}}{{julian_day}}.{{version}}.full.png',
					projection: new ol.proj.Projection({
						code: 'comp-img',
						units: 'pixels',
						extent: [-180, -90, 180, 90],
					}),
					imageExtent: [-180, -90, 180, 90],
				}),
			});
			map.addLayer(graphic);
		}
	</script>
	<h2 style="color:rgb(61,147,56); float:left"> {% trans "MODIS TERRA composite map" %}</h2><br /><br /><br />
	<h4 style="color:rgb(17,34,215); float:left;">{{prod}}/{{sat_name}}_{{sat_ver}}({{version}}):<b>{{year}}-{{julian_day}}</b></h4>

	<div id="map" class="map" style="height: 675px;"></div>
	<div class="row justify-content-around" style="margin: 60px 0px 10px 0px;">
		<div>
			<a href="/composite/{{previous8_year}}/{{previous8_day}}/" class="btn btn-primary mx-1" role="button">
				<span class="fas fa-chevron-left"></span> 8
			</a>

			<a href="/composite/{{next8_year}}/{{next8_day}}/" class="btn btn-primary mx-1" role="button">
				8 <span class="fas fa-chevron-right"></span>
			</a>
		</div>

		<div>
			<button type="button" class="btn btn-primary mx-1" onclick="set50km()"> {% trans "50 km" %} <span class="fas fa-globe-americas"></span></button>
			<button type="button" class="btn btn-primary mx-1" onclick="set5km()"> {% trans "5 km" %} <span class="fas fa-search-plus"></span></button>
		</div>
	</div>

	<div class="row justify-content-around mb-5">
		<div class="col-lg-5 m-2 card bg-light shadow-sm">
			<div class="row justify-content-around mt-3">
				<div class="form-group row mx-2">
					<label class="col col-form-label">{% trans "Year" %}:</label>
					<div style="width: 80px">
						<input class="form-control" id="JUL_YEAR" type="number" min="2000" max="{%now "Y"%}" step="1" placeholder="Year" value="{{year}}">
					</div>
				</div>
				<div class="form-group row mx-2">
					<label class="col col-form-label">{% trans "Date" %}:</label>
					<div style="width: 80px">
						<input class="form-control" id="JUL_DAY" type="number" min="1" max="365" step="1" placeholder="Julian day" value="{{julian_day}}">
					</div>
				</div>
				<div class="form-group row mx-3">
					<button class="btn btn-primary" onclick="julianSubmit()">{% trans "Submit" %}</button>
				</div>
			</div>

		</div>
		<div class="col-lg-5 m-2 card bg-light shadow-sm">
			<div class="row justify-content-around mt-3">
				<div class="form-group row mx-2">
					<label class="col col-form-label">{% trans "Calendar" %}:</label>
					<div style="width: 200px">
						<input class="form-control" id="CAL_DATE" type="text" style="position: relative; z-index: 100000;" placeholder="click to choose the date" readonly="readonly">
					</div>
				</div>
				<div class="form-group row mx-3">
					<button class="btn btn-primary" onclick="calendarSubmit()">{% trans "Submit" %}</button>
				</div>
			</div>
		</div>
	</div>

	<div id="accordion">
		<!--What the heck? Why is the accordion functionality tied to the id??-->
		<h3> {% trans "Julian calendar Leap years" %} </h3>
		<div>
			{% include "modis/julianCalendarLeap.html" %}
		</div>
		<h3> {% trans "Julian calendar Regular years" %} </h3>
		<div>
			{% include "modis/julianCalendarRegular.html" %}
		</div>
	</div>

	<script>
		console.log("https://landweb.nascom.nasa.gov/browse/images/{{version}}/{{sat_name}}/{{prod}}/{{year}}/A{{year}}{{julian_day}}/MOD09.A{{year}}{{julian_day}}.{{version}}.png")
	
		const extent = [-180, -90, 180, 90];
		const projection = new ol.proj.Projection({
			code: 'comp-img',
			units: 'pixels',
			extent: extent,
		});

		graphic = new ol.layer.Image({
			source: new ol.source.ImageStatic({
				url: 'https://landweb.nascom.nasa.gov/browse/images/{{version}}/{{sat_name}}/{{prod}}/{{year}}/A{{year}}{{julian_day}}/MOD09.A{{year}}{{julian_day}}.{{version}}.png',
				projection: projection,
				imageExtent: extent,
			}),
		});
	
		const map = new ol.Map({
			layers: [graphic],
			target: 'map',
			view: new ol.View({
				projection: projection,
				center: ol.extent.getCenter(extent),
				zoom: 2,
				maxZoom: 8,
			}),
			controls: []
		});
	</script>
	{% endblock %}