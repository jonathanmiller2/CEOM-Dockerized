{% extends "visualization/base.html" %}
{% load i18n %}
{% block title %} {% trans "CEOM MODIS timeseries Single Site" %} {% endblock %}

{% block head_extra %}
<script defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBo98LuzUr-aVpxRZPFHkBl2m4ogHeROGQ&callback=init"></script>



{% endblock %}

{% block body_tag %}

<body bgcolor="#FFFFFF">{% endblock %}
    {% block content %}


<div id="accordion">
    <h3 style="color:#999900;"><strong>{% trans "Instructions" %}</strong></h3>

    <p>{% trans "Here you can retrieve time series MODIS data for a single study site, in other words, the time series MODIS data from one MODIS pixel that contains your study site. The data you get are in ASCII text file and Microsoft Excel *.csv file." %} </p>
    <ol>
        <li>
            <p>{% trans "<strong>Define the location </strong> of your study site" %}</p>
            <ul>
                <li>
                    <p>{% trans "Enter an address (e.g., street address, or city, or state)" %}</p>
                </li>
                <li>
                    <p>{% trans "Enter latitude and longitude of your study using Degree, Minute and Second Units" %}</p>
                </li>
                <li>
                    <p>{% trans "Enter latitude and longitude of your study using Decimal degree Unit" %}</p>
                </li>
            </ul>
            <p><b>(OR)</b></p>
            <p><strong>{% trans "Zoom-in the Google map</strong> and then <strong>click on a point</strong> of interest to adjust the location if required." %}<br \>
                    <small>{% trans "Note: The rectangle in Google Map is the boundary of one MODIS pixel, and the red dot is the location of your study site within the MODIS pixel." %}</small>
            </p>
        </li>
        <li>
            <p><strong>{% trans "Select product and year(s)" %}</strong><br \>
                <small>{% trans "You may choose one MODIS product over one year or several years." %}</small> </p>
        </li>
        <li>
            <p>{% trans "<strong> Submit</strong> your request. <small> Note: Upon submitting make sure you have done all previous steps or an error message will appear </small>" %} </p>
        </li>
    </ol>

</div>
<h2 style="color: #dc143c;">{% trans "Retrieve time series MODIS data for a single study site" %}</h2>

<legend><strong>{% trans "1a.Select an address or a Point on the Map" %}</strong> </legend>

<div id="div_address">
    <div class="row">
        <label class="col-sm-2 my-1">Enter the address:</label>
        <input class="form-control col-sm-3 mx-2 my-1" id="Taddress" type="text" name="address">
        <button class="btn btn-light btn-outline-secondary col-sm-1 mx-2 my-1" id="addressGo" style="border-width: 1.6px;">{% trans "Go" %}</button>
    </div>
</div>
<p><b>(OR)</b></p>
<div>
    <legend class="pt-2"><strong>{% trans "1b.Enter the latitude & longitude information" %}</strong> </legend>
    <div class="row">
        <label class="col-sm-2"></label>
        <label class="col-sm-2 mx-2" style="text-align:center">Degrees</label>
        <label class="col-sm-2 mx-2" style="text-align:center">Minutes</label>
        <label class="col-sm-2 mx-2" style="text-align:center">Seconds</label>
    </div>
    <div class="row">
        <label class="col-sm-2 my-1 pt-1">Latitude:</label> <!-- DMS Lat -->
        <input id="LAT_DEG" class="DMSField form-control col-sm-2 mx-2 my-1" type="number" step="1" placeholder="Degrees">
        <input id="LAT_MIN" class="DMSField form-control col-sm-2 mx-2 my-1" type="number" step="1" placeholder="Minutes">
        <input id="LAT_SEC" class="DMSField form-control col-sm-2 mx-2 my-1" type="number" step="any" placeholder="Seconds">
    </div>

    <div class="row">
        <label class="col-sm-2 my-1 pt-1">Longitude:</label> <!-- DMS Lon -->
        <input id="LON_DEG" class="DMSField form-control col-sm-2 mx-2 my-1" type="number" step="1" placeholder="Degrees">
        <input id="LON_MIN" class="DMSField form-control col-sm-2 mx-2 my-1" type="number" step="1" placeholder="Minutes">
        <input id="LON_SEC" class="DMSField form-control col-sm-2 mx-2 my-1" type="number" step="any" placeholder="Seconds">
        <button class="btn btn-light btn-outline-secondary col-sm-1 mx-2 my-1" onclick="enterCoordsDMS();" style="border-width: 1.6px;">{% trans "Go" %}</button>
    </div>
    <label class="pt-2 my-1">or enter <strong>Decimal degrees</strong> below:</label> <!-- decimal degrees -->
    <div class="row">
        <label class="col-sm-2 my-1 pt-1">Latitude:</label>
        <input id="LAT_DEC" class="DECField form-control col-sm-2 mx-2 my-1 offset1" type="number" step="any" placeholder="Latitude">
        <label class="col-sm-2 my-1 mx-2 pt-1">Longitude:</label>
        <input id="LON_DEC" class="DECField form-control col-sm-2 mx-2 my-1 offset1" type="number" step="any" placeholder="Longitude">
        <button class="btn btn-light btn-outline-secondary col-sm-1 mx-2 my-1" id="RedirectControl" onclick="enterCoordsLatLon();" name="RedirectControl" style="border-width: 1.6px;">Go</button>
    </div>
</div>

<div class="pt-2">
    <p><b>(OR)</b></p>
</div>
<legend class="text-left"><strong>{% trans "1c. Zoom-in the map and then click on a point of interest" %} </strong></legend>

<div id="map" class="mr-auto" style="width: 90%; height: 450px"></div>

<div class="row">
    <div class="col-sm-3">
        <input type="checkbox" id="auto_zoom" name="auto_zoom" checked /> Zoom to Modis Pixel</div>
    <div class="col-sm-5">
        <small>
            <label style="color:blue;">Blue pixel : 250 M</label> |
            <label style="color:red;">Red pixel : 500 M</label> |
            <label style="color:green;">Green pixel : 1000 M/1 KM</label>
        </small>
    </div>
</div>
<legend class="text-left"><strong>{% trans "2. Select a product and year(s)" %} </strong></legend>
<div>
    <div class="row">
        <div class="col-lg">
            <label class="col-sm-1">{% trans "Dataset" %}</label>
            <select id="datasetPane" class="form-control col-sm-6" size="4" disabled>
                {% for d in datasets %}
                <option value="{{d|lower}}" npix="{{d.xdim}}" title="{{d.long_name}}">{{d|upper}}</option>
                {% endfor %}
            </select>
        </div>
        <div id="Modis_long">

        </div>
        <div class="col-lg">
            <label class="col-sm-1">{% trans "Year" %}</label>
            <select id="yearsPane" class="form-control col-sm-6" multiple="multiple" disabled>
                {% for y in years %}
                <option value="{{y}}">{{y}}</option>
                {% endfor %}
            </select>
        </div>
    </div>
    <legend class="text-left mt-2"><strong>{% trans "3. Submit your request" %}</strong></legend>

    <div align="center" class="mr-5">
        <button class="btn btn-primary" onclick="showResults();">{% trans "Submit" %}</button>
        <button class="btn btn-info" onclick="resetValues();">{% trans "Reset" %}</button>
    </div>
</div>



{% if photoRedirect %}
<input id="lonRedirect" type=hidden value={{lonRedirect}}></input>
<input id="latRedirect" type=hidden value={{latRedirect}}></input>
<script type="text/javascript">
    autoRedirectWork();
</script>
<input id="conditionReload" type=hidden value="true"></input>
{%endif%}
<script>
    $(document).ready(function () {
        //if($("#LON_DEC").value!=null){
        // enterCoordsLatLon();
        //}
        $("#datasetPane").change(function () {
            self = this;
            var newpix = $(this).find("option:selected").attr("npix");
            var newname = $(this).find("option:selected").attr("value");
            var longname = $(this).find("option:selected").attr("title");
            console.log(newpix);
            $("#Modis_long").html("<b>About:</b><br/>" + longname + "<br/>For more infomation click on this link<br/><a href=https://lpdaac.usgs.gov/dataset_discovery/modis/modis_products_table/" + newname + ">" + newname + "<a/>");
            handlefeatures(newpix);
        })
    })
</script>
<script>
    // ------------------------------------------------------------------------------------------------------------------------------------------------------------- TODO: Delete this later
    function toDMS(decimalVal) {
        var degree = Math.trunc(decimalVal);
        var minute = Math.trunc((decimalVal - degree) * 60);
        var second = Math.trunc(((decimalVal - degree) * 60 - minute ) * 60);

        return [degree, minute, second];
    }
    
    let startLocation = {
        lat: 0,
        lng: 0
    };

    
    var radians = function(x){
        return x * Math.PI / 180.0; 
    };

    var degrees = function(x){
        return x * 180.0 / Math.PI;
    };
    let map, marker;
    let polygon, polygon2, polygon3;
    // -------------------------------------------------------------------------- INIT ------------------------------------------------------------------------------ TODO: Delete this later
    function init() {
        map =  new google.maps.Map(document.getElementById('map'), { // Remember to remove the "var" here. It's not a new variable at this line anymore.
            zoom: 2,
            center: startLocation,
            gestureHandling: 'cooperative',
            mapTypeId: 'satellite',
        });;
        let box = latlon2pixel(78,-43, 2400.0);
        let box2 = latlon2pixel(78, -43, 4800.0);
        let box3 = latlon2pixel(78, -43, 1200.0);
        
        polygon = new google.maps.Polygon({ 
            paths: box,
            strokeColor: "#FF3300",                 
            strokeOpacity: 0.9,
            strokeWeight: 2,                                 
            fillOpacity: 0,
            clickable: false,                 
        });;
        polygon2 = new google.maps.Polygon({ 
            paths: box2,
            strokeColor: "Blue",                 
            strokeOpacity: 0.9,
            strokeWeight: 2,                                 
            fillOpacity: 0,
            clickable: false,                 
        });;
        polygon3 = new google.maps.Polygon({ 
            paths: box2,
            strokeColor: "#75FF30",                 
            strokeOpacity: 0.8,
            strokeWeight: 2,                                 
            fillOpacity: 0,
            clickable: false,                 
        });;
     
        marker = new google.maps.Marker({
            position: startLocation,
            map: map,
            draggable: true,
        });

        google.maps.event.addListener(marker, 'dragend', function (evt) {
            let lat = evt.latLng.lat().toFixed(3);
            let lon = evt.latLng.lng().toFixed(3);

            let dms_lat = toDMS(lat);
            let dms_lon = toDMS(lon);

            $('#LAT_DEG').val(dms_lat[0])
            $('#LAT_MIN').val(dms_lat[1])
            $('#LAT_SEC').val(dms_lat[2])

            $('#LON_DEG').val(dms_lon[0])
            $('#LON_MIN').val(dms_lon[1])
            $('#LON_SEC').val(dms_lon[2])

            $('#LAT_DEC').val(lat)
            $('#LON_DEC').val(lon)
            marker.setPosition({lat: evt.latLng.lat(), lng: evt.latLng.lng()});
            updatePixelDisplay(map, marker, lat, lon);
        });

        google.maps.event.addListener(map, 'click', function (evt) {
            let lat = evt.latLng.lat().toFixed(3);
            let lon = evt.latLng.lng().toFixed(3);

            let dms_lat = toDMS(lat);
            let dms_lon = toDMS(lon);

            $('#LAT_DEG').val(dms_lat[0])
            $('#LAT_MIN').val(dms_lat[1])
            $('#LAT_SEC').val(dms_lat[2])

            $('#LON_DEG').val(dms_lon[0])
            $('#LON_MIN').val(dms_lon[1])
            $('#LON_SEC').val(dms_lon[2])

            $('#LAT_DEC').val(lat)
            $('#LON_DEC').val(lon)
            marker.setPosition({lat: evt.latLng.lat(), lng: evt.latLng.lng()});
            updatePixelDisplay(map, marker, lat, lon);
        });

        $(".DMSField").change(function() {
            //... get new DMS coords (just reading from the fields, not using (this.value)...
            let lat_deg = parseFloat($('#LAT_DEG').val() || 0);
            let lat_min = parseFloat($('#LAT_MIN').val() || 0);
            let lat_sec = parseFloat($('#LAT_SEC').val() || 0);
            let lon_deg = parseFloat($('#LON_DEG').val() || 0);
            let lon_min = parseFloat($('#LON_MIN').val() || 0);
            let lon_sec = parseFloat($('#LON_SEC').val() || 0);

            //... update Decimal degrees fields... // Remember to use JQuery $().value to update the Decimal Degrees field.
            let lat_dec = lat_deg + parseFloat(parseFloat(lat_min + (lat_sec / 60)) / 60);
            let lon_dec = lon_deg + parseFloat(parseFloat(lon_min + (lon_sec / 60)) / 60);
            $('#LAT_DEC').val(lat_dec.toFixed(3))
            $('#LON_DEC').val(lon_dec.toFixed(3))
            //...update map...
            marker.setPosition({lat: lat_dec, lng: lon_dec});
            updatePixelDisplay(map, marker, lat_dec, lon_dec);
        });

        $(".DECField").change(function() {
            let lat_dec = parseFloat($('#LAT_DEC').val() || 0);
            let lon_dec = parseFloat($('#LON_DEC').val() || 0);

            let dms_lat = toDMS(lat_dec);
            let dms_lon = toDMS(lon_dec);

            $('#LAT_DEG').val(dms_lat[0])
            $('#LAT_MIN').val(dms_lat[1])
            $('#LAT_SEC').val(dms_lat[2])
            $('#LON_DEG').val(dms_lon[0])
            $('#LON_MIN').val(dms_lon[1])
            $('#LON_SEC').val(dms_lon[2])

            marker.setPosition({lat: lat_dec, lng: lon_dec});
            updatePixelDisplay(map, marker, lat_dec, lon_dec); 
        });
        
        marker.setMap(map);
        polygon.setMap(map);
        polygon2.setMap(map);
        polygon3.setMap(map);
        const geocoder = new google.maps.Geocoder();
        document.getElementById("addressGo").addEventListener("click", () => {
            geocodeAddress(marker, geocoder, map, polygon, polygon2, polygon3);
        });
    }

    function geocodeAddress(marker, geocoder, resultsMap, polygon1, polygon2, polygon3) {
        const address = document.getElementById("Taddress").value;
        geocoder
            .geocode({ address: address })
            .then(({ results }) => {
                marker.setPosition(results[0].geometry.location);
                let lat = results[0].geometry.location.lat().toFixed(3);
                let lon = results[0].geometry.location.lng().toFixed(3);
              
                let dms_lat = toDMS(parseFloat(lat));
                let dms_lon = toDMS(parseFloat(lon));
                
                $('#LAT_DEG').val(dms_lat[0]);
                $('#LAT_MIN').val(dms_lat[1]);
                $('#LAT_SEC').val(dms_lat[2]);

                $('#LON_DEG').val(dms_lon[0]);
                $('#LON_MIN').val(dms_lon[1]);
                $('#LON_SEC').val(dms_lon[2]);

                $('#LAT_DEC').val(lat);
                $('#LON_DEC').val(lon);
                updatePixelDisplay(resultsMap, marker, lat, lon);
            })
            .catch((e) =>
            alert("Geocode was not successful for the following reason: " + e)
            );        
    }

    async function updatePixelDisplay(map, marker, lat, lng) { //This function shouldn't return anything, it should just move the polygon
        let box = latlon2pixel(lat, lng, 2400.0);
        let box2 = latlon2pixel(lat, lng, 4800.0);
        let box3 = latlon2pixel(lat, lng, 1200.0);
        polygon.setPath(box);
        polygon2.setPath(box2);
        polygon3.setPath(box3);
        if($("#auto_zoom").is(":checked")) {
            let mzs = new google.maps.MaxZoomService();
            let zoomobj = await mzs.getMaxZoomAtLatLng(marker.getPosition());
            map.setZoom(Math.min(zoomobj.zoom, 15));
            map.setCenter(marker.getPosition())
        }
    }

    // Sinusoidal Grid: 0-35h (horizontal) & 0-17v (vertical) | g : the pixel number from the starting point (0) (=global) | xi : pixel x inside a tile | npix : number of pixels
    let sin2latlon = function(ih, iv, xi, yi, npix) {
        let cons =(36.0 * npix)/(2.0 * Math.PI);
        let yg = iv * npix + yi;
        let xg = ih * npix + xi;

        let lat = degrees((9.0 * npix) - yg) / cons; 
        let lon = degrees(xg - 18.0 * npix) / (cons * Math.cos(radians(lat)));
        
        return {lat:lat, lon:lon};
    };
    
    let latlon2sin = function(lat, lon, npix) {
        let cons =(36.0 * npix)/(2.0 * Math.PI);
        let yg = 9.0 * npix - radians(cons * lat);
        let xg = radians(cons*lon*Math.cos(radians(lat))) + 18.0 * npix;

        let ih = Math.floor(xg/npix);
        let iv = Math.floor(yg/npix);

        let x = xg-ih*npix;
        let y = yg-iv*npix;

        let xi = Math.floor(x);
        let yi = Math.floor(y);

        return {h: ih, v: iv, x: xi, y: yi};
    };
    
    let latlon2pixel = function(lat, lon, npix){
        let sin = latlon2sin(lat, lon, npix);
        let ih = sin.h, iv = sin.v, xi = sin.x, yi = sin.y;
        let bbox = [];
        let p;
       
        p = sin2latlon(ih, iv, xi + 0, yi + 0, npix);
        bbox.push({lat: p.lat, lng: p.lon});
        p = sin2latlon(ih, iv, xi + 0, yi + 1, npix);
        bbox.push({lat: p.lat, lng: p.lon});
        p = sin2latlon(ih, iv, xi + 1, yi + 1, npix);
        bbox.push({lat: p.lat, lng: p.lon});
        p = sin2latlon(ih, iv, xi + 1, yi + 0, npix);
        bbox.push({lat: p.lat, lng: p.lon});
        return bbox;
    };

    function getTile(lon, lat){
        var bbox = latlon2pixel(lat, lon);
        var projto = map.getProjectionObject();

        var points = [];
        for (var i = 0; i < bbox.length; i++){
            points.push(new OpenLayers.Geometry.Point(bbox[i][0],bbox[i][1]));
        }

        var geom = new OpenLayers.Geometry.Polygon(new OpenLayers.Geometry.LinearRing(points));
        return geom.transform(proj, projto);
    }

</script>
{% endblock %}