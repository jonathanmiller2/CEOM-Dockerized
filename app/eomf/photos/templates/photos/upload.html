{% extends "photos/base.html" %}
{% load i18n %}
{% block title %}{% trans "EOMF photo upload" %} {% endblock %}

{% block content %}

{% if request.user.is_authenticated %}
<h4>{% trans "Upload" %}</h4>

<div class="upload-container">
    <ul>
        <li>{% trans "You can select multiple files, drag&amp;drop files into the window with Firefox, Safari, Chrome" %}</li>
        <li><span style="color:red"><big>{% trans "Don't forget to click"%}<b> {%trans "'Save Uploaded Images'"%} </b> {%trans "after uploading all the images" %}</big></span></li>
        <li>{% trans "The default setting for photos is public, if you want to change it to private, then check the 'private box'"%}
            <input id="checkbox2" type="checkbox" class="toggle"></li>
    </ul>

    <input id="file-select-input" type="file" name="files[]" style="display: none;" multiple />

    <button id="file-select-button" type="button" class="btn btn-success">
        <span>{% trans "Add Files..." %}</span>
    </button>

    <button id="file-submit-button" type="submit" class="btn btn-info">
        <span>{% trans "Start upload" %}</span>
    </button>

    <button id="file-reset-button" type="button" class="btn btn-warning">
        <span>{% trans "Cancel upload" %}</span>
    </button>

    <!-- The global progress bar -->
    <div class="progress">
        <div id="progress-bar" class="progress-bar progress-bar-striped" role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
    </div>

    <div id="file-list"></div>

    <form enctype="multipart/form-data" action="." method="POST">
        {% csrf_token %}
        {% trans "The default setting for photos is public, do you want to change it to private?" %}
        <input id="checkbox1" type='checkbox' class="toggle" name='private' value='Yes'>
        <input type="hidden" name="subupload" value="1">
        <input id="submithide" type="submit" class="btn btn-primary" value="Save Uploaded Images">
    </form>
</div>
<hr />

<div>
    <h3>{% trans "Notes" %}</h3>
    <ul>
        <li>{% trans "Please upload individual images (<strong>JPEG, PNG, GIF</strong>)" %}</li>
        <li>{% trans "Total upload limit is set at 650MB, but it is recommended you do not upload files bigger than <strong>25MB</strong>." %}</li>
        <li>{% trans "If you are having trouble uploading big files (over 25M) select multiple smaller files in the file browse window." %}</li>
        <li>{% trans "You can <strong>drag &amp; drop</strong> files from your desktop on this webpage with Google Chrome, Mozilla Firefox and Apple Safari." %}</li>
    </ul>
</div>

<!-- gallery-modal is the modal dialog used for the image gallery -->
<div id="gallery-modal" class="modal hide fade">
    <div class="modal-header">
        <a href="#" class="close">&times;</a>
        <h3 class="title"></h3>
    </div>
    <div class="modal-body"></div>
    <div class="modal-footer">
        <a class="btn primary next">{% trans "Next" %}</a>
        <a class="btn info prev">{% trans "Previous" %}</a>
        <a class="btn success download" target="_blank">{% trans "Download" %}</a>
    </div>
</div>
</div>

{% else %}
{% trans "Please Log in to upload photos." %}
{% endif %}

<script>
    $(function () {
        let fileSelectInput = $('#file-select-input');
        let fileSelectButton = $('#file-select-button');
        let fileSubmitButton = $('#file-submit-button');
        let fileResetButton = $('#file-reset-button');
        let fileList = $('#file-list');
        let files = [];
        let idIncrement = 0;

        function IDSuccessfullyUploaded(givenID) {
            let intID = parseInt(givenID);
            let index = files.map(function(e) { return e.id; }).indexOf(intID);
            files[index].uploaded = true;

            $(`#upload-button-${intID}`).css( "display", "none" );
            $(`#cancel-button-${intID}`).css( "display", "none" );
            $(`#delete-button-${intID}`).css( "display", "inline" );
        }

        fileSelectInput.change(function () {
            for (let index = 0; index < fileSelectInput[0].files.length; index++) {
                let file = fileSelectInput[0].files[index];
                idIncrement++;
                info = {
                    "id": idIncrement,
                    "file": file,
                    "uploaded": false
                };
                files.push(info);

                let fileElement = $(`
                    <div id="uploaded-photo-${info.id}" class="card bg-light">
                        <div class="card-body row">
                            <p class="card-text">${info.file.name}</p>
                            <div class="progress col-3 m-0 p-0">
                                <div id="progress-bar-${info.id}" class="progress-bar progress-bar-striped" role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                            </div>
                            <button id="upload-button-${info.id}" type="button" class="btn btn-info">
                                {% trans "Start upload" %}
                            </button>
                            <button id="cancel-button-${info.id}" type="button" class="btn btn-warning">
                                {% trans "Cancel upload" %}
                            </button>
                            <button id="delete-button-${info.id}" type="button" class="btn btn-danger" style="display: none;">
                                {% trans "Delete" %}
                            </button>
                        </div>
                    </div>
                `);

                fileElement.find(`#cancel-button-${info.id}`).click(function (event) {

                    let buttonName = $(event.target).attr('id');
                    let ID = buttonName.split('-')[2];
                    let fileElement = $(`#uploaded-photo-${ID}`);
                    //Alternatively:
                    //let fileElement = $(event.target).parent().parent();
                    
                    let indexToRemove = files.map(function(e) { return e.file; }).indexOf(fileElement.data('fileData'));
                    fileElement.remove();
                    files.splice(indexToRemove, 1);
                });

                fileElement.find(`#upload-button-${info.id}`).click(function (event) {

                    let buttonName = $(event.target).attr('id');
                    let ID = buttonName.split('-')[2];
                    let fileElement = $(`#uploaded-photo-${ID}`);
                    //Alternatively:
                    //let fileElement = $(event.target).parent().parent();

                    let index = files.map(function(e) { return e.file; }).indexOf(fileElement.data('fileData'));

                    let formData = new FormData();
                    formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
                    formData.append('file', files[index].file);

                    $.ajax({
                        xhr: function () {
                            var xhr = new window.XMLHttpRequest();
                        
                            xhr.upload.addEventListener("progress", function (evt) {
                                if (evt.lengthComputable) {
                                    var percentComplete = (evt.loaded / evt.total) * 100;
                                    $(`#progress-bar-${ID}`).attr('aria-valuenow', percentComplete).css('width', percentComplete+'%');
                                    console.log(percentComplete);
                                }
                            }, false);
                        
                            xhr.addEventListener("progress", function (evt) {
                                if (evt.lengthComputable) {
                                    var percentComplete = (evt.loaded / evt.total) * 100;
                                    $(`#progress-bar-${ID}`).attr('aria-valuenow', percentComplete).css('width', percentComplete+'%');
                                    console.log(percentComplete);
                                }
                            }, false);
                            return xhr;
                        },
                        url: './preload/',
                        data: formData,
                        type: 'POST',
                        success: function () {
                            IDSuccessfullyUploaded(ID);
                        },
                        cache: false,
                        processData: false,
                        contentType: false
                    });
                    
                    files[index].uploaded = true;
                });

                fileElement.find(`#delete-button-${info.id}`).click(function (event) {
                    let buttonName = $(event.target).attr('id');
                    let ID = buttonName.split('-')[2];
                    let fileElement = $(`#uploaded-photo-${ID}`);
                    //Alternatively:
                    //let fileElement = $(event.target).parent().parent();

                    let index = files.map(function(e) { return e.file; }).indexOf(fileElement.data('fileData'));

                    let formData = new FormData();
                    formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

                    $.ajax({
                        xhr: function () {
                            var xhr = new window.XMLHttpRequest();
                        
                            xhr.upload.addEventListener("progress", function (evt) {
                                if (evt.lengthComputable) {
                                    var percentComplete = (evt.loaded / evt.total) * 100;
                                    $(`#progress-bar-${ID}`).attr('aria-valuenow', percentComplete).css('width', percentComplete+'%');
                                    console.log(percentComplete);
                                }
                            }, false);
                        
                            xhr.addEventListener("progress", function (evt) {
                                if (evt.lengthComputable) {
                                    var percentComplete = (evt.loaded / evt.total) * 100;
                                    $(`#progress-bar-${ID}`).attr('aria-valuenow', percentComplete).css('width', percentComplete+'%');
                                    console.log(percentComplete);
                                }
                            }, false);
                            return xhr;
                        },
                        url: `./preload/delete/${files[index].file.name}`,
                        type: 'POST',
                        success: function () {
                            let indexToRemove = files.map(function(e) { return e.file; }).indexOf(fileElement.data('fileData'));
                            fileElement.remove();
                            files.splice(indexToRemove, 1);
                        },
                        cache: false,
                        processData: false,
                        contentType: false
                    });
                });

                fileElement.data('fileData', info.file);
                fileList.append(fileElement);
            }
        });

        fileSelectButton.click(function () {
            fileSelectInput.click();
        });

        fileSubmitButton.click(function () {
            let formData = new FormData();
            formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

            let IDsToUpload = [];

            files.forEach(i => {
                if(!i.uploaded)
                {
                    IDsToUpload.push(i.id);
                    formData.append('file', i.file);
                }
            });

            console.log('Sending...');

            $.ajax({
                xhr: function () {
                    var xhr = new window.XMLHttpRequest();

                    xhr.upload.addEventListener("progress", function (evt) {
                        if (evt.lengthComputable) {
                            var percentComplete = (evt.loaded / evt.total) * 100;
                            $('#progress-bar').attr('aria-valuenow', percentComplete).css('width', percentComplete+'%');
                            console.log(percentComplete);
                        }
                    }, false);

                    xhr.addEventListener("progress", function (evt) {
                        if (evt.lengthComputable) {
                            var percentComplete = (evt.loaded / evt.total) * 100;
                            $('#progress-bar').attr('aria-valuenow', percentComplete).css('width', percentComplete+'%');
                            console.log(percentComplete);
                        }
                    }, false);
                    return xhr;
                },
                url: './preload/',
                data: formData,
                type: 'POST',
                success: function () {
                    IDsToUpload.forEach(i => {
                        IDSuccessfullyUploaded(i);
                    })
                },
                cache: false,
                processData: false,
                contentType: false
            });
        });

        fileResetButton.click(function() {

            keptFiles = [];

            files.forEach(i => {
                if(!i.uploaded)
                {
                    let fileElement = $(`#uploaded-photo-${i.id}`);
                    let indexToRemove = files.map(function(e) { return e.file; }).indexOf(fileElement.data('fileData'));
                    fileElement.remove();
                }
                else
                {
                    keptFiles.push(i);
                }
            });

            files = keptFiles;
        });



        $("#checkbox1").change(function () {
            if ($("#checkbox2").is(":checked")) {
                $("#checkbox2").attr('checked', false);
            } else {
                $("#checkbox2").attr('checked', true);
            }
        });
        $("#checkbox2").change(function () {
            if ($("#checkbox1").is(":checked")) {
                $("#checkbox1").attr('checked', false);
            } else {
                $("#checkbox1").attr('checked', true);
            }
        });
    });
</script>
{% endblock %}